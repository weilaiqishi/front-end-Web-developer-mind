# 5.state更新流程(setState里到底发生了什么)

教程地址
<https://xiaochen1024.com/article_item/600acba1245877002ed5deff>

介绍在更新状态之后到render阶段的流程

## 在react中触发状态更新的几种方式

- ReactDOM.render
- this.setState
- this.forceUpdate
- useState
- useReducer

## this.setState和this.forceUpdate

1.this.setState内调用this.updater.enqueueSetState

2.this.forceUpdate和this.setState一样，只是会让tag赋值ForceUpdate
如果标记ForceUpdate，render阶段组件更新会根据checkHasForceUpdateAfterProcessing，和checkShouldComponentUpdate来判断，如果Update的tag是ForceUpdate，则checkHasForceUpdateAfterProcessing为true，当组件是PureComponent时，checkShouldComponentUpdate会浅比较state和props，所以当使用this.forceUpdate一定会更新

3.enqueueForceUpdate之后会经历创建update，调度update等过程，接下来就来讲这些过程

状态更新整体流程
![状态更新整体流程](https://gitee.com/xiaochen1024/assets/raw/master/assets/_18.png)

### 创建Update

​HostRoot或者ClassComponent触发更新后，会在函数createUpdate中创建update，并在后面的render阶段的beginWork中计算Update。FunctionComponent对应的Update在第11章讲，它和HostRoot或者ClassComponent的Update结构有些不一样

``` js
export function createUpdate(eventTime: number, lane: Lane): Update<*> {//创建update
  const update: Update<*> = {
    eventTime,
    lane,
  
    tag: UpdateState,
    payload: null,
    callback: null,
  
    next: null,
  };
  return update;
}
```

- lane：优先级（第12章讲）
- tag：更新的类型，例如UpdateState、ReplaceState
- payload：ClassComponent的payload是setState第一个参数，HostRoot的payload是ReactDOM.render的第一个参数
- callback：setState的第二个参数
- next：连接下一个Update形成一个链表，例如同时触发多个setState时会形成多个Update，然后用next 连接

### updateQueue

​对于HostRoot或者ClassComponent会在mount的时候使用initializeUpdateQueue创建updateQueue，然后将updateQueue挂载到fiber节点上


